volumes:
  ny_taxi_postgres_data:
    driver: local
  kestra_postgres_data:
    driver: local
  kestra_data:
    driver: local
  kestra_tmp:
    driver: local

services:
  pgdatabase:
    image: postgres:18
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: ny_taxi
    ports:
      - "5432:5432"
    volumes:
      - ny_taxi_postgres_data:/var/lib/postgresql
    depends_on:
      kestra:
        condition: service_started

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=root
    ports:
      - "8085:80"
    depends_on:
      pgdatabase:
        condition: service_started

  kestra_postgres:
    image: postgres:18
    volumes:
      - kestra_postgres_data:/var/lib/postgresql
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 10

  kestra:
    image: kestra/kestra:v1.1
    pull_policy: always
    # Note that this setup with a root user is intended for development purpose.
    # Our base image runs without root, but the Docker Compose implementation needs root to access the Docker socket
    # To run Kestra in a rootless mode in production, see: https://kestra.io/docs/installation/podman-compose
    user: "root"
    command: server standalone
    volumes:
      - kestra_data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - kestra_tmp:/tmp/kestra-wd
    environment:
      SECRET_GCP_CREDS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidGVycmFmb3JtLWRlbW8tNDg1MzEyIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMTMxMDQ5MzQ3OWNkODljZWQ1ZDM4ZGM2NTg5OWM5NWE5OGYxZmYwNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDclJmWmhjaUxBa0Z2aFxuVk1jNzBLenppQXB1QWljNXdiazlaMnRwTzVHdVFRM0ZHa0NiTFhSNkNQWmc2bWk3aWRzbkU0dkNkVjR2NXlzV1xuVDlQeWFDV0lPNlVEWFFlZHptMUxuNGVmOW5LRWl4d2tUV1BYZUQrM3BnSG12VUJGbnhnN0F1MXJOQ3FlZ0pGUFxuNlBKT29ld200Qk1BcU12RmVpSnZ1R0RORVBlSHcvQXAzd1IwYWhkMmFRV3NFYnFyUWJ6NlQ3Zm5UcDlTUVdLT1xuN25QTG05eGQ3U1JKMDUweFpkQWl3OG83Y3cyeW9KRUdVcExLcy9BV05ZUFdPWXBRMWpnc1luS3RBc1RBM0hLS1xuSGJGTi9OVW9RRjVISGdkQlkyRmxjWUVQSXlTcFFsSk0yT1kyS1VxZEZSWjg0WHVDUDJhaUxremxIV2tCdUdTYVxuQ1p4TXBoUE5BZ01CQUFFQ2dnRUFBVFFXSlp3a00xOHdUaGFHNmR3dkF1MFBTYk9aSy9ZNUEzM3hDc1hBNGMwU1xuT0RMVmhtR2M0bWlpdG82ZkdzWSt0SGtXTDlFY1R0RGNoQ1VlYzZNWXRHcmEzM210WG9YL1RaczYzRHhpbEp6WFxubjBldDdtc3BZM1IycWZUbGVUZkRkMUt2Y1dQbDhzUXJnVGk5VHlFakpDako2V1RHUGNaOGJIV0t0SllzYnhkRlxuNWp1ZmlrRVRzUkVQUDduT2dTL0tmVVJleWNPU0pYeGQzYW11b2pPc3cyY2pXaXpkWHBYZXIzNDZaTWpjbmFsSFxuay94RnVCNVJGMlhuM3hCZHVGeWZaTHFPalRINURlMXBmVGRGQ2c5QTZIL0VzV1FUOXozTW9mbEd4SUg0QlQxY1xudnhJK3VhenR4TDlXUE5uWHdja3k2bzlxVE53YTdmbTJ5MmVwNUpFU3Z3S0JnUUR2TWIyc0tEU245ZFJTYjJPelxuNms2OEp2VUt3SThETzBBc3g1R0VBV1RHM3pOV3cxUTROUHNIQWU0RGFLV3hCK1FJOUU4NmZIZUxhWFNzVTJpL1xua09GSmhhQUtNby9PRjQ3MURBeWxIK2h4cmRYSGUrcGc3WnMweFVLVnN4Sml4cWVmeHhTWkpTZUR6VHliVlFCYVxuWTNQN1YxbDNKdStIcEFscGJMYjRycGR0THdLQmdRQzNUcEFaUk9xeDJzY2Mrd3oxelVzRXIwd3hHMjQzdHhvSFxuNWpDVGtuT3l4c1djL0lKdFdqdndIbUduSVF0bThFakVoSjEvanZyMDBPTzNBYlh6TklKRmRRaE1RNjE1VzM0dFxuN05RSVlpeFBta2lTUWdSNTlFdHcyZ3lZcGQ3OHNrMzlEV3BiQWpDQk9XbE9UTTJjdllpWXU4YThrdDdIZUpEUFxudjlTTzY2Qm53d0tCZ1FDbVliQXhGNHFCSnVPNUw5aG5wdDE3elpGNEdEZWlwTTFnR0xYazM5OU00cWRnZStDU1xuZEhBRkVOZVNNWEhIOGRneVRsYnFOUGdtMW9VYzlhd1FUT1FZODBVK3Nxc0xUYUhZWExoVENCMzFMVmxlT0pqeFxuTVhaYnY3Y3dVRzdDbkxLdTFwbENhZkRSb3FxODFlUzMreVFMT2xoMkpIUkxvdFFWTEZVZUtMd1dhd0tCZ1FDSVxuUzREM1dQZk1vR2cyVXpDU3Z6OU5UMjR1Z1QvVmEyNk9ld2laWVdabmdrWkM4TG1seDFjVHRmTlVDa3pwRURaNlxuOEVRUEtXZk5pbGdXcGMzODlJajhUZ1dLZHpQUUxVaEhxM1VJZXI2SnZhVENJeFlpKzVMd2FTQytpMjZlbzVFN1xuVzdNOTBnWHd2NWhlSU5zczlQeFEzQ1hyNXFTQTJsT0tOUTg5NlZNT2N3S0JnQ2FsSmsxWkhTVEFuR0hTa1ZDVVxuMjFuc0VlSDhSd08ySXN0YllNb3RFZTFYZ0VialR4M1hsUkFhcHFPZ0I0S1ptWUUrbkExa0RHb3B2VlRzU213clxudGt6eGxRalF6aGN2QmloNyszYWo2RVNNRGJGbWd6RVpXTnBTZTEyb0FkRXY0TEdTTENtbUp0ZnZQdTluL3J6YlxuTG5tNlJuTGR0QjNxMGtnR1lkY1VhN2VVXG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAidGVycmFmb3JtLXJ1bm5lckB0ZXJyYWZvcm0tZGVtby00ODUzMTIuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTE1MTMwNTM1NzQwMTg3NjQ2MjI1IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS90ZXJyYWZvcm0tcnVubmVyJTQwdGVycmFmb3JtLWRlbW8tNDg1MzEyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIgp9Cg==
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra_postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            basicAuth:
              username: "admin@kestra.io" # it must be a valid email address
              password: Admin1234!
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      kestra_postgres:
        condition: service_started
    